# Deployment Troubleshooting Guide

## Issues Faced During Azure App Service Deployment

### Issue 1: App Name Mismatch in Workflow
**Problem:** GitHub Actions workflow had incorrect Azure App Service name
- Workflow referenced: `app-name: 'my-social-profile'`
- Actual App Service name: `rajamahesharavapalli-profile`

**Error Message:**
```
Deployment failed, Error: Publish profile is invalid for app-name and slot-name provided
```

**Solution:**
Update `.github/workflows/deploy.yml` to use correct app name:
```yaml
app-name: 'rajamahesharavapalli-profile'
```

**Lesson Learned:** Always ensure app names match between Azure Portal and workflow configuration.

---

### Issue 2: GitHub Secret Not Configured
**Problem:** Azure publish profile credentials not added to GitHub repository secrets

**Error Message:**
```
No credentials found. Add an Azure login action before this action.
```

**Solution:**
1. Download publish profile XML from Azure App Service
2. Go to GitHub repository → Settings → Secrets and variables → Actions
3. Create new secret: `AZURE_WEBAPP_PUBLISH_PROFILE`
4. Paste entire XML content as the secret value
5. Ensure workflow references the secret: `publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}`

**Lesson Learned:** Always configure GitHub secrets before triggering deployments that require authentication.

---

### Issue 3: web.config Only Works on Windows IIS
**Problem:** Attempted to use `web.config` for SPA routing on Azure Linux App Service

**What Happened:**
- `web.config` is IIS-specific (Windows Server)
- Our App Service runs on Linux with Node.js
- File was ignored, routing failed

**Solution:**
Create `server.js` with Express.js to handle routing:
```javascript
import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.static(path.join(__dirname, 'dist')));

// SPA fallback
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

**Lesson Learned:** Platform-specific configuration files (web.config for IIS, .htaccess for Apache) don't work across platforms. Use Node.js server for cross-platform SPA routing.

---

### Issue 4: Cross-Platform Command Incompatibility
**Problem:** Used Windows `copy` command in GitHub Actions (Ubuntu-based)

**Error Message:**
```
shell: /usr/bin/bash -e {0}
copy: command not found
```

**Solution:**
Use Unix-compatible command: `cp` instead of `copy`
```yaml
- name: Copy web.config to dist
  run: cp web.config dist/web.config  # Not: copy web.config dist/web.config
```

**Lesson Learned:** GitHub Actions runs on Linux by default. Always use Unix commands when scripting deployments.

---

### Issue 5: Deploying Only dist/ Folder Instead of Full Project
**Problem:** Workflow deployed only `dist/` folder (static files)
- `server.js` not included in deployment
- `node_modules` not included
- `package.json` not included

**Result:**
- Azure detected it as a static site
- Ran default static site handler: `node /opt/startup/default-static-site.js`
- Express server never started
- Got blank "waiting for content" page

**Error Log Evidence:**
```
node /opt/startup/default-static-site.js
```

**Solution:**
Change workflow deployment package from `dist/` to `.` (current directory):
```yaml
deploy:
  app-name: 'rajamahesharavapalli-profile'
  publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
  package: .  # Deploy entire project, not just dist/
```

**Why This Works:**
1. Azure detects `package.json` and recognizes it as Node.js app
2. Azure automatically runs `npm install` to install dependencies
3. Azure automatically runs `npm start` from package.json
4. Our `server.js` starts and serves the SPA correctly

**Lesson Learned:** When deploying Node.js apps, deploy the entire project directory so the platform can properly detect and configure the app.

---

## Complete Deployment Flow (Working Solution)

### 1. Project Structure Required
```
my-social-profile/
├── server.js              # Express server for SPA routing
├── package.json           # Includes "start": "node server.js"
├── .github/
│   └── workflows/
│       └── deploy.yml     # CI/CD pipeline
├── src/
│   ├── components/
│   ├── config/
│   ├── styles/
│   └── ...
├── dist/                  # Built React app (generated by npm run build)
└── ...
```

### 2. package.json Configuration
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "start": "node server.js",
    "lint": "eslint ."
  },
  "dependencies": {
    "express": "^4.18.2",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-icons": "^5.5.0"
  }
}
```

### 3. GitHub Actions Workflow
```yaml
- name: Deploy to Azure App Service
  uses: azure/webapps-deploy@v3
  with:
    app-name: 'rajamahesharavapalli-profile'
    publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
    package: .  # CRITICAL: Deploy entire project
```

### 4. Express Server (server.js)
- Serves static files from `dist/` folder
- Implements SPA fallback routing
- Listens on PORT environment variable (set by Azure)

---

## Debugging Tips

### Check Log Stream in Azure Portal
1. Go to App Service → Monitoring → Log stream
2. See real-time errors from your Node.js app
3. Helps identify startup issues, missing modules, etc.

### Check Deployment Logs
1. Go to Deployment Center
2. View logs for each deployment attempt
3. Look for:
   - Build errors
   - Missing dependencies
   - Command not found errors
   - Port binding issues

### Common Log Messages
- **"Starting OpenSSH"** - Normal, app is starting
- **"Build completed successfully"** - npm run build worked
- **"Running hooks"** - Post-deployment scripts running
- **"Deployment successful"** - Files deployed but app may not have started

### Test Locally First
```bash
npm install
npm run build
npm start
```
Then visit `http://localhost:3000` to verify everything works before pushing.

---

## Key Takeaways

1. **App Names Matter**: Ensure consistency between Azure Portal and workflow configuration
2. **Secrets Configuration**: Always set up GitHub secrets before deployment
3. **Platform-Specific Files**: Use Node.js servers instead of IIS config files for Linux deployments
4. **Command Compatibility**: Use Unix commands in GitHub Actions (running on Linux)
5. **Full Project Deployment**: Deploy entire project directory, not just dist/ folder, so Azure recognizes it as a Node.js app
6. **SPA Routing**: Implement fallback routing in server.js for client-side routing
7. **Dependency Management**: Include dependencies in deployed package; let Azure handle npm install

---

## Timeline of Fixes

| Step | Issue | Fix | Result |
|------|-------|-----|--------|
| 1 | App name mismatch | Updated workflow app-name parameter | Deployment runs |
| 2 | No credentials | Added GitHub secret | Authentication succeeds |
| 3 | IIS config on Linux | Created Express server | Platform-compatible routing |
| 4 | Wrong command | Changed `copy` to `cp` | Command executes |
| 5 | Only dist/ deployed | Changed package from `dist/` to `.` | Express server starts |

---

## Final Working State
✅ GitHub Actions CI/CD configured
✅ Automatic builds on push to main
✅ Express server handles SPA routing
✅ All dependencies properly deployed
✅ App runs on Azure App Service (Linux, Node 22 LTS)
✅ Live at: https://rajamahesharavapalli-profile.azurewebsites.net

